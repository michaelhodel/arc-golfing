def p(g):A=range;B=len;D=sorted;F=lambda q:D(set(c:=sum(q,[])),key=c.count);I=[*map(list,(g,zip(*g))[R:=B(g)>B(g[0])])];h,w=B(I),B(I[0])//2;T,S=D([[r[:w]for r in I],[r[w:]for r in I]],key=lambda q:B(F(q)));f,b=F(S)[-2:];z=F(T)[-1];[exec('for r in S[y:y+H]:r[x:x+W]=[b]*W')or[all(T[u+j][v:v+W]==[(m,z)[m==f]for m in t[j]]for j in A(H))and exec('for j in A(H):T[u+j][v:v+W]=t[j]')for u in A(h-H+1)for v in A(w-W+1)]for n in[3,2,1]for y in A(h)for x in A(w)for H in A(h-y,0,-1)for W in A(w-x,0,-1)if b not in(c:=sum(t:=[r[x:x+W]for r in S[y:y+H]],[]))and H*W-c.count(f)==n];return(T,[*zip(*T)])[R]